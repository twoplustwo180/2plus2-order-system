<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <title>購物車</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="bg-gray-50 min-h-screen p-4">
  <div class="max-w-xl mx-auto">
    <h1 class="text-2xl font-bold mb-6 text-center">購物車</h1>
    <ul id="cart-list" class="space-y-3 mb-4"></ul>
    <div class="text-right text-lg mb-2">總金額：<span id="total-price" class="font-bold text-blue-600">$0</span></div>

    <a href="index.html" class="block w-full text-center bg-gray-200 text-gray-800 py-3 rounded-lg shadow-md hover:bg-gray-300 mb-4">
      &larr; 回到菜單
    </a>

    <button id="submit-order" class="w-full bg-green-600 text-white py-3 rounded-lg shadow-md hover:bg-green-700">送出訂單</button>
  </div>

  <script>
    let cart = JSON.parse(localStorage.getItem('cart') || '[]');

    function groupCart(cart) {
      const grouped = {};
      cart.forEach(item => {
        if (!grouped[item.name]) {
          grouped[item.name] = { ...item, quantity: 1 };
        } else {
          grouped[item.name].quantity += 1;
        }
      });
      return grouped;
    }

    function saveCart(grouped) {
      const flat = [];
      Object.values(grouped).forEach(item => {
        for (let i = 0; i < item.quantity; i++) {
          flat.push({ name: item.name, price: item.price });
        }
      });
      localStorage.setItem('cart', JSON.stringify(flat));
      cart = flat;
    }

    function renderCart() {
      const cartList = document.getElementById('cart-list');
      const totalPriceEl = document.getElementById('total-price');
      cartList.innerHTML = '';
      let total = 0;

      const grouped = groupCart(cart);

      Object.values(grouped).forEach(item => {
        const li = document.createElement('li');
        li.className = "bg-white rounded-xl p-3 shadow flex justify-between items-center";

        li.innerHTML = `
          <div>
            <div class="font-semibold">${item.name}</div>
            <div class="text-gray-600">$${item.price} x ${item.quantity}</div>
          </div>
          <div class="flex items-center space-x-2">
            <button onclick="updateQuantity('${item.name}', -1)" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">-</button>
            <span>${item.quantity}</span>
            <button onclick="updateQuantity('${item.name}', 1)" class="px-2 py-1 bg-gray-200 rounded hover:bg-gray-300">+</button>
          </div>
        `;

        cartList.appendChild(li);
        total += item.price * item.quantity;
      });

      totalPriceEl.textContent = `$${total}`;
    }

    function updateQuantity(name, delta) {
      const grouped = groupCart(cart);
      if (!grouped[name]) return;

      grouped[name].quantity += delta;
      if (grouped[name].quantity <= 0) {
        delete grouped[name];
      }
      saveCart(grouped);
      renderCart();
    }

    document.getElementById('submit-order').onclick = async () => {
      const grouped = groupCart(cart);
      const items = Object.values(grouped).map(i => `${i.name} x${i.quantity}`).join(', ');
      const total = cart.reduce((sum, i) => sum + i.price, 0);

      await fetch('https://twoplus2-backend.onrender.com/submit-order', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ items, total })
      });

      localStorage.removeItem('cart');
      window.location.href = 'success.html';
    };

    renderCart();
  </script>
</body>
</html>
